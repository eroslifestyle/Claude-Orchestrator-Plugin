name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT

      - name: Create distribution packages
        run: |
          echo "Creating distribution packages for version ${{ steps.version.outputs.VERSION }}"

          # Create core zip (skills + agents)
          if [ -d "core" ]; then
            zip -r orchestrator-core-${{ steps.version.outputs.VERSION }}.zip core/
            echo "Created orchestrator-core-${{ steps.version.outputs.VERSION }}.zip"
          else
            echo "ERROR: core/ directory not found"
            exit 1
          fi

          # Create templates zip
          if [ -d "templates" ]; then
            zip -r orchestrator-templates-${{ steps.version.outputs.VERSION }}.zip templates/
            echo "Created orchestrator-templates-${{ steps.version.outputs.VERSION }}.zip"
          else
            echo "WARNING: templates/ directory not found, skipping"
          fi

          # List created files
          ls -la *.zip

      - name: Generate checksums
        run: |
          echo "Generating SHA256 checksums..."
          sha256sum *.zip > checksums.sha256
          echo "Checksums:"
          cat checksums.sha256

      - name: Prepare release notes
        id: notes
        run: |
          if [ -f "CHANGELOG.md" ]; then
            # Extract changelog section for this version
            VERSION_PATTERN=$(echo "${{ steps.version.outputs.VERSION }}" | sed 's/^v//')

            # Try to extract the relevant section from CHANGELOG.md
            awk -v ver="$VERSION_PATTERN" '
              /^## \[?[0-9]/ { in_section=0 }
              $0 ~ "## \\[?" ver { in_section=1; next }
              in_section { print }
              /^## / && in_section { exit }
            ' CHANGELOG.md > release_notes.md || true

            # If extraction failed or empty, use full changelog
            if [ ! -s release_notes.md ]; then
              cp CHANGELOG.md release_notes.md
            fi

            echo "notes_file=release_notes.md" >> $GITHUB_OUTPUT
          else
            # Create default release notes
            echo "# Release ${{ steps.version.outputs.VERSION }}" > release_notes.md
            echo "" >> release_notes.md
            echo "## Included Packages" >> release_notes.md
            echo "" >> release_notes.md
            echo "- **orchestrator-core-${{ steps.version.outputs.VERSION }}.zip**: Core orchestrator files (skills + agents)" >> release_notes.md
            echo "- **orchestrator-templates-${{ steps.version.outputs.VERSION }}.zip**: Template files" >> release_notes.md
            echo "- **checksums.sha256**: SHA256 checksums for verification" >> release_notes.md
            echo "" >> release_notes.md
            echo "## Installation" >> release_notes.md
            echo "" >> release_notes.md
            echo "1. Download the required packages" >> release_notes.md
            echo "2. Verify checksums: \`sha256sum -c checksums.sha256\`" >> release_notes.md
            echo "3. Extract to your Claude config directory" >> release_notes.md
            echo "notes_file=release_notes.md" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ steps.version.outputs.VERSION }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.VERSION, '-') }}
          files: |
            *.zip
            checksums.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-packages-${{ steps.version.outputs.VERSION }}
          path: |
            *.zip
            checksums.sha256
          retention-days: 30
